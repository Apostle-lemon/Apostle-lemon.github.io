# 44 正确运用 Fake Stub 和 Mock 等辅助单元测试

在 43 讲中，提到了 golang 测试时可能会对外部的文件数据产生依赖。这一讲我们关注于被测代码对外部业务组件或服务的依赖。接下来要讨论的 fake, stub 和 mock 之间并非是泾渭分明的。

## Fake

真实组件或服务的简化实现版替身。例如我们可以用一个基于内存的数据库来替换真实的数据库。Fake 并不能在测试前对返回结果进行预设值。

## Stub

对返回结果有一定预控制能力的替身，这种控制可以通过测试前对调用结果进行预设置。例如，被测试函数中声明包级类型函数变量 `var getSign = sign.Get`，但是我们在测试函数中可以先用 old 保存 sign.Get，然后声明自己的 sign.Get 函数，从而获得内容。

github 上的 gostub 可以方便地进行 stub 替换。

## Mock

mock 替身更加强大，它不仅能提供测试前的预设置返回结果能力，还可以对 mock 替身对象在测试过程中的行为进行观察和验证。mock 一般需要第三方框架实现 mock 替身。

Go 官方维护了一个 mock 框架，gomock，该框架通过代码生成方式实现某接口的替身类型。

在被测试代码头部增加 `go generate` 命令提示符。使用 `go generate` 之后会在我们指示的 destination 位置添加 一个 mock 替身，之后我们可以用这个 mock 替身进行测试。

除了 gomock 这样一个通用的测试外，也有专门用于创建 sql/drive 的 go-sqlmock 等更加细化的 mock 框架。


