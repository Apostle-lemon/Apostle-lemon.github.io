# 爬虫 基础

## Urlopen

```python
import urllib.request

url = 'http://www.baidu.com'
response = urllib.request.urlopen(url)
print(response.read().decode('utf-8'))
```

## Request

```python
import urllib.request

request = urllib.request.Request('http://www.baidu.com')
response = urllib.request.urlopen(request)
print(response.read().decode('utf-8'))
```

这里看似没有什么区别，但是我们可以在构造 request 时更加方便，例如我们可以

```python
from urllib import request, parse
url = 'http://httpbin.org/post ’
headers = {
	'User-Agent': 'Mozilla/4.0 (compatible; MSIE S. S; Windows NT )'
}
dict = {
		'name' : 'Germey'
}
data= bytes(parse.urlencode(dict), encoding='utf8 ’)
req = request.Request(url=url, data=data, headers=headers, method ='POST')
response = request.urlopen(req)
print(response. read(). decode(' utf-8'))
```

## Requests

别再用过时的 urllib 了，我们不妨直接用 requests 库，而后直接 requests.get(url) 来获得 response 吧

## Selenium

我们爬取猫眼电影 TOP 100 的时候有可能会遇到会进入到猫眼验证中心的情况，需要我们滑动进度条进行验证，我们需要使用 selenium 进行进度条的滑动，帮助我们进行验证。

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301131827852.png)

这里的滑动验证码在源码中并没有提供背景图，因此我们通过获得带缺口的背景图片和滑块的图片，通过 opencv 库对图片进行识别，缺口匹配，得出最优的匹配结果，锁定滑块的运动轨迹。我们通过以下的步骤解决这个问题：

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301131834966.png)

初始化信息

```python
def __init__(self):
	# 获取链接
	self.url = 'https://maoyan.com/board/4?offset=100'
	# 获取浏览器驱动
	self.browser = webdriver.Chrome()
	# 设置显式等待
	self.wait = WebDriverWait(self.browser, 10)
```

下一步就是进行定位。

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301131932027.png)

注意这里的验证模块是使用 iframe 写入的，也就是当前页面的子页面，在 selenium 中打开网页后，默认是在当前页面（父页面）中进行操作的，因此我们需要切换到子 frame。我们使用 switch_to.frame() 方法就可以切换到 iframe。

示例代码

```python
from selenium import webdriver
 
broswer = webdriver.Chrome()
broswer.get('网页链接')
broswer.switch_to.frame('iframe的id或者name值')
```

我们可以通过如下代码来查看是否进入到了猫眼电影验证界面的 iframe。

```python
# 如果输出的是 UTF-8 utf-8，那么就代表正确进入到了 iframe  
from selenium import webdriver  
from selenium.webdriver.common.by import By  
import time  
  
broswer = webdriver.Chrome()  
broswer.get('https://maoyan.com/board/4')  
time.sleep(2)  
iframe = broswer.find_elements(By.TAG_NAME, "iframe")[0]  
  
broswer.switch_to.frame(iframe)  
element = broswer.find_element(By.XPATH, '//head/meta')  
print(element.get_attribute('charset')) # UTF-8  
  
broswer.switch_to.default_content()  
elements = broswer.find_element(By.XPATH, '//head/meta')  
print(elements.get_attribute('charset')) # utf-8
```

接下来我们需要定位到滑块的图片元素和背景元素，我们使用 iframe 中对应的 xpath 即可完成。

在获取到滑块元素和背景元素之后，我们可以使用边缘检测的方式匹配图片的缺口。例如，我们获得如下的背景图片和滑块图片

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301132118764.png)

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301132119644.png)

那么我们在使用边缘检测之后，就可以得到如下的图像边缘

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301132119450.png)

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301132120439.png)

在这种情况下，我们再使用 cv2 库提供的 cv2.minMaxLoc() 方法即可完成缺口的匹配。

![](https://lemonapostlepicgo.oss-cn-hangzhou.aliyuncs.com/img/202301132122613.png)

在完成了缺口的匹配之后，我们就可以生成鼠标的运动轨迹，从最开始的地方到匹配到的地方。因为这里是水平的滑块，因此我们只需要设置 x 轴方向上的运动即可。另外我们为了更加符合人移动的规律，采用了先加速移动后减速移动的方式获得轨迹。

在有了运动轨迹之后，我们调用 ActionChains( ).move_by_offset( ) 即可拖动滑块移动到我们匹配到缺口的位置。

reference : [selenium+opencv解决猫眼电影排行榜带缺口滑动验证码问题_Yy_Rose的博客-CSDN博客](https://blog.csdn.net/Yy_Rose/article/details/121723111)

ps：一个验证 selenium 环境是否可以正常使用的小代码

```python
from selenium import webdriver  
from selenium.webdriver.common.keys import Keys  
from selenium.webdriver.common.by import By  
from selenium.webdriver.chrome.service import Service  
  
browser = webdriver.Chrome()  
  
browser.get('http://www.baidu.com')  
search = browser.find_element(By.ID, 'kw')  
search.send_keys('python')  
search.send_keys(Keys.ENTER)  
  
# browser.close()
```
